<?php
///ini_set('display_errors',0);
$pagetype = 2;
include "../include/method.php";
include "../include/masamune_api.php";
include "../include/uniform.php";
include "../include/replace_text.php";



if (isset($_GET['entry'])){
  $recruit_type = 3;
} elseif(isset($_GET['fulltime'])) {
  $recruit_type = 1;
} elseif(isset($_GET['parttime'])){
  $recruit_type = 2;
} else {
  location (D_SSL."fulltime.html");
  exit;
}



$page_flag = 0;
$error = array();

include "../include/entry_method-1.php";

header("X-XSS-Protection: 1; mode=block");
header("X-FRAME-OPTIONS: DENY");
header('X-Content-Type-Options:nosniff');
header('Cache-Control: private,no-store,must-revalidate');

$title = "応募フォーム";
$para1 = "ceo";
$para2 = "";
$para3 = "";
$para4 = "";
$para5 = "";
PrintHeader($title, $para1, $para2, $para3, $para4, $para5);
?>


<!-- start -->

  <!-- container start -->
<div class="container-slide demo-2">
    <div id="head2" class="clearfix">
    <h1 style="color:white;">
    <span><a href="<?php print h(D_SSL); ?>"><img src="./img/eidai_logo_400_white.png" style="width:200px;" alt="EIDAI"></a></span>
    <span>One for all, All for one</span>
    </h1>
    </div>
</div>
  <!-- container end -->



<!--page wrap start-->
<div class="page_wrap">

<div class="wrapper-inner">
<div class="wrapper-inner2">
<div class="t-a-c">
<div class="font-b" style="background: linear-gradient(transparent 85%, #ffaa0d 20%);display:inline-block">
<?php if ($recruit_type===1) { ?>正社員応募フォーム
<?php } else if ($recruit_type===2) { ?>アルバイト応募フォーム
<?php } else if ($recruit_type===3) { ?>エントリーフォーム
<?php } else if ($recruit_type!==1||2||3) { ?>エラー
<?php die("不正なアクセスです。最初からやり直してください"); ?>
<?php } ?>
</div>
<div class="font-m">
<?php if ($recruit_type===1) { ?>Application for a Full-time Employee
<?php } elseif ($recruit_type===2) { ?>Application for a Part-time Employee
<?php } elseif ($recruit_type===3) { ?>Know About Our Company
<?php } ?>
</div>
</div>
</div>
</div>





<div class="contact_form">
<div class="inner_side">

<?php
////////////////////////////////////////////////
////////////////////////////////////////////////
//// 確認処理（page_flag === 1）
////////////////////////////////////////////////
////////////////////////////////////////////////

	if($page_flag === 1) {

//// transaction token check
////////////////////////////////////////////////
	if ($_REQUEST["tt"] != "") {
	$tt = $_SESSION["tt"];
	$tt_post = $_REQUEST["tt"];
		if ($tt != $tt_post) {
		echo "session error !<br><br></div></div></div>";
		Printfooter($para1, $para2, $para3);
		exit;
		}
	} else {
	echo "session error !<br><br></div></div></div>";
	Printfooter($para1, $para2, $para3);
	exit;
	}

//// Create onetime ticket
////////////////////////////////////////////////
$ttt = "";
$ttt = sha1(uniqid(mt_rand(), true));
$_SESSION["ttt"] = "";
$_SESSION["ttt"] = $ttt;
?>

<div class="ccheader">
<h1>送信内容確認</h1>
</div>


<form action="" method="post">
<input type="hidden" name="ttt" value="<?php print h($ttt); ?>">
<input type="hidden" name="name" value="<?php print h($name); ?>">
<input type="hidden" name="phonetic" value="<?php print h($phonetic); ?>">
<input type="hidden" name="year" value="<?php print h($year); ?>">
<input type="hidden" name="month" value="<?php print h($month); ?>">
<input type="hidden" name="day" value="<?php print h($day); ?>">
<input type="hidden" name="sex" value="<?php print h($sex); ?>">
<input type="hidden" name="tel" value="<?php print h($tel); ?>">
<input type="hidden" name="mail" value="<?php print h($mail); ?>">
<input type="hidden" name="preferred" value="<?php print h($pre); ?>">
<input type="hidden" name="experience" value="<?php print h($exp); ?>">
<input type="hidden" name="pro_con" value="<?php print h($pro); ?>">
<input type="hidden" name="self_appeal" value="<?php print h($self); ?>">
<input type="hidden" name="episode" value="<?php print h($ep); ?>">
<input type="hidden" name="eat" value="<?php print h($eat); ?>">

<table class="table01">

<tr>
<th><span class="DDD bg"><i class="fa">  お名前</i></span></th>
<td class="bga"><?php echo h($name); ?></td>
</tr>
<tr>
<th><span class="DDD bg"><i class="fa">  フリガナ</i></span></th>
<td class="bga"><?php echo h($phonetic); ?></td>
</tr>
<tr>
<th><span class="DDD bg"><i class="fa">  生年月日 </i></span></th>
<td class="bga"><?php echo h($year) ."年". h($month) ."月". h($day) ."日"; ?></td>
</tr>
<tr class="not">
<th><span class="DDD bg"><i class="fa">  性別 </i></span></th>
<td class="bga">
<?php switch($sex) {
	case 1: echo "男性"; break;
	case 2: echo "女性"; break;
	case 9: echo "その他"; break;
} ?>
</td>
</tr>
<tr>
<th><span class="DDD bg"><i class="fa">  連絡先電話番号</i></span></th>
<td class="bga"><?php echo h($tel); ?></td>
</td>
</tr>
<tr>
<th><span class="DDD bg"><i class="fa">  メールアドレス</i></span></th>
<td class="bga"><?php echo h($mail); ?></td>
</tr>
<tr class="not">
<th><span class="DDD bg"><i class="fa">  希望職種</i></span></th>
<td class="bga">
<?php switch($pre) {
	case 1: echo "システムエンジニア"; break;
	case 2: echo "プログラマ"; break;
	case 3: echo "サーバエンジニア"; break;
	case 4: echo "webエンジニア"; break;
	case 5: echo "データベースエンジニア"; break;
	case 9: echo "その他"; break;
} ?></td>
</tr>
<tr class="not">
<th><span class="DDD bg"><i class="fa">  IT経験年数</i></span></th>
<td class="bga">
<?php switch($exp) {
	case "A": echo "3年以上"; break;
	case "B": echo "2年以上3年未満"; break;
	case "C": echo "1年以上2年未満"; break;
	case "D": echo "1年未満"; break;
	case "E": echo "未経験"; break;
} ?></td>
</tr>
<tr class="not">
<th><span class="DDD bg"><i class="fa">  長所と短所</i></span></th>
<td class="bga cont"><?php echo nl2br(h($pro)); ?></td>
</tr>
<tr class="not">
<th><span class="DDD bg"><i class="fa">  自己PR</i></span></th>
<td class="bga cont"><?php echo nl2br(h($self)); ?></td>
</tr>
<tr class="not">
<th><span class="DDD bg"><i class="fa">  人柄エピソード</i></span></th>
<td class="bga cont"><?php echo nl2br(h($ep)); ?></td>
</tr>
<tr class="not">
<th><span class="DDD bg"><i class="fa">  食事会</i></span></th>
<td class="bga">
<?php
	if ($_REQUEST["eat"] == "1") {
	echo "希望する";
	} else {
	echo "希望しない";
	}
?>
</tr>
</table>

<!-- 送信＆訂正ボタン -->
<div class="check_page_btn">
<input type="submit" name="btn_back" value="訂正" onclick="history.back()" class="ccbtn2">
<input type="submit" name="btn_send" value="送信" class="ccbtn">
</div>
</form>
<br><br>








<?php
/////////////////////////////////////////////
/////////////////////////////////////////////
/// 送信完了処理（page_flag == 2）
/////////////////////////////////////////////
/////////////////////////////////////////////

	} else if ($page_flag === 2) {

include "../include/DB_check_method.php";
if ($check_err == 0) {


switch ($sex) {
	case 1: $sex_name="男性"; break;
	case 2: $sex_name="女性"; break;
	case 9: $sex_name="その他"; break;
}

switch ($pre) {
	case 1: $pre_name="システムエンジニア"; break;
	case 2: $pre_name="プログラマ"; break;
	case 3: $pre_name="サーバエンジニア"; break;
	case 4: $pre_name="webエンジニア"; break;
	case 5; $pre_name="データベースエンジニア"; break;
	case 9: $pre_name="その他"; break;
}

switch ($exp) {
	case 'E': $exp_name="未経験"; break;
	case 'D': $exp_name="1年未満"; break;
	case 'C': $exp_name="2年未満"; break;
	case 'B': $exp_name="3年未満"; break;
	case 'A': $exp_name="3年以上"; break;
}

switch ($recruit_type) {
	case 1: $rec_name="正社員"; break;
	case 2: $rec_name="アルバイト"; break;
	case 3: $rec_name="エントリーのみ"; break;
}

if ($eat == 1) {
	$meal = 1;
} else {
	$meal = 0;
}

function makeRandStr($length = 6) {
    static $chars = "abcdefghijklmnopqrstuvwxyz";
    $str = "";
    for ($i = 0; $i < $length; ++$i) {
        $str .= $chars[mt_rand(1,24)];
    }
    return $str;
}
  
date_default_timezone_set('Asia/Tokyo');
$ltd = makeRandStr();
$limit_time = $ltd.strtotime('+48 hours');
$hash = get_sha256($mail);
////$hash_p = password_hash($hash,PASSWORD_BCRYPT);
//// パスワードハッシュが効かないため　get_stretched_password　を使う
$hash_p = get_stretched_password(D_SCODE, $hash);

/////////////////////////////////////////////
/// MASAMUNE 登録（ユーザーテーブル）
/////////////////////////////////////////////
$user_mail = $mail;
$user_count = getUserCountByMail($user_mail);
if ($user_count == 0) {
	$nowdatetime = date("Y-m-d H:i:s");
	$mvaluelist = array();
	$mvaluelist["有効化"] = "valid";
	$mvaluelist["フォーム終了フラグ"] = 1;  ///フォーム終了時に1代入
	$mvaluelist["メールアドレス"] = $user_mail;
	$mvaluelist["メールアドレス2"] = $hash;
	$mvaluelist["フォーム終了日時"] = $date;
	$regdid = $NBCLIENT->reg(T_USER,"",$mvaluelist);
} else {
	$one = getUserOneByMail($user_mail);
	$did = $one["did"];
	$mvelue = array();
	$mvaluelist["フォーム終了フラグ"] = 1;
	$mvaluelist["フォーム終了日時"] = $date;
	$regdid = $NBCLIENT->reg(T_USER,$did,$mvaluelist);
}

/////////////////////////////////////////////
/// MASAMUNE 登録（フォーム情報テーブル）
/////////////////////////////////////////////
if ($recruit_type !== 3) {
	$mvaluelist = array();
	$mvaluelist["登録日時"] = $date;
	$mvaluelist["氏名"] = $name;
	$mvaluelist["フリガナ"] = $phonetic;
	$mvaluelist["生年月日"] = $birthday;
	$mvaluelist["性別"] = $sex;
	$mvaluelist["連絡先"] = $tel;
	$mvaluelist["メールアドレス"] = $mail;
	$mvaluelist["採用種別"] = $rec_name;
	$mvaluelist["希望職種"] = $pre_name;
	$mvaluelist["IT実務経験年数"] = $exp_name;
	$mvaluelist["長所短所"] = $pro;
	$mvaluelist["自己PR"] = $self;
	$mvaluelist["エピソード"] = $ep;
	$mvaluelist["お食事会"] = $meal;
	$mvaluelist["結合用コード"] = $ltd;
	$mvaluelist["有効化"] = "valid";
	$regdid = $NBCLIENT->reg(T_FORM, "",$mvaluelist);
} else {
	$mvaluelist = array();
	$mvaluelist["登録日時"] = $date;
	$mvaluelist["氏名"] = $name;
	$mvaluelist["フリガナ"] = $phonetic;
	$mvaluelist["生年月日"] = $birthday;
	$mvaluelist["連絡先"] = $tel;
	$mvaluelist["メールアドレス"] = $mail;
	$mvaluelist["採用種別"] = $rec_name;
	$mvaluelist["有効化"] = "valid";
	$regdid = $NBCLIENT->reg(T_FORM,"",$mvaluelist);
}

/////////////////////////////////////////////
/// MASAMUNE 登録（フォームチェックテーブル）
/////////////////////////////////////////////
$mvaluelist = array();
$mvaluelist["期限"] = $limit_time;
$mvaluelist["ハッシュ"] = $hash_p;
$mvaluelist["登録日時"] = $date;
$regdid = $NBCLIENT->reg(T_FORMCHECK, "", $mvaluelist);


////////ここまで/////////////

  include "../include/mail_send.php";

  $_SESSION["tt"] = "";
  $_SESSION["ttt"] = "";

////if ($check_err == 0)  end
}
  ?>

<script>
	$(window).on( "popstate", function(event){
	/// このページで「戻る」を実行
	history.pushState(null, null, null);
	});
</script>
<script>
	$(function(){
      /// 自身のページを履歴に追加
      history.pushState(null, null, null);
      /// ページ戻り時にも自身のページを履歴に追加
      	$(window).on("popstate", function(){
		history.pushState(null, null, null);
      	});
	});
</script>

<?php
	if ($check_err == 0) {
?>
<div class="ccheader"><h1>送信完了</h1></div>
<h3 class="end_msg">
<div>ご応募ありがとうございました。</div>
<br>
<div>内容の控えをメールにてお送りいたしました。</div>
<?php
	if ($recruit_type !== 3) {
?>
<div>また、応募後の流れも記載されておりますので、</div>
<div>必ずご確認ください。</div>
<?php } ?>
</h3>

<?php
	} else if ($check_err == 20) {
?>
<div class="ccheader"><h1>送信失敗</h1></div>
<p><?php echo "error code:". h($check_err); ?><p>
<h3 class="end_msg">
<div>フォーム登録済みです。</div>
<div>再度登録希望の場合はお問い合わせください。</div>
</h3>
<?php
	} else {
?>
<div class="ccheader"><h1>送信失敗</h1></div>
<p><?php echo "error code:". h($check_err); ?><p>
<h3 class="end_msg">
<div>処理が中断されました。</div>
<div>初めからやり直してください。</div>
</h3>
<?php } ?>







<?php
/////////////////////////////////////////////
/////////////////////////////////////////////
/// フォーム（page_flag が1でも2でもない）
/////////////////////////////////////////////
/////////////////////////////////////////////
	} else {


	//// Create new transaction token
	////////////////////////////////////
	$_SESSION["tt"] = "";
	$tt = sha1(uniqid(mt_rand(), true));
	$_SESSION["tt"] = $tt;
?>

<br>
<div>下記フォームの項目を入力して送信してください。</div>
<div>3営業日以内に担当者より折り返しご連絡させていただきます。</div>
<div>お急ぎの方はお電話にてお問い合わせください。</div>

<p><span class="err_message">※全項目入力必須</span></p>
<br>

<?php
	if (!empty($error)) {
?>
<div class="err_message">
<ul>
<?php
	foreach ($error as $value) {
?>
<li><?php echo h($value); ?></li>
<?php } ?>
</ul>
</div>
<br><br>
<?php } ?>



  <form id="contact" class="" action="" method="post">
  <input name="tt" type="hidden" value="<?php print h($tt); ?>">

<table class="table01">

  <tr>
   <th><span class="DDD"><i class="fa">  お名前 </i></span></th>
   <td><input type="text" name="name" maxlength="20" class="validate[required] ccformfield"
     value="<?php if(!empty($_POST['name'])){echo h($name);} ?>" ></td>
  </tr>

  <tr>
   <th><span class="DDD"><i class="fa">  フリガナ </i></span></th>
   <td><input type="text" name="phonetic" maxlength="40" class="validate[required] ccformfield"
     value="<?php if(!empty($_POST['phonetic'])){echo h($phonetic);} ?>" ></td>
  </tr>

  <tr>
    <th><span class="DDD"><i class="fa">  生年月日 </i></span></th>
    <input type="hidden" name="birthday" value="">
    <td>
    西暦
    <input type="tel" name="year" maxlength="4" class="validate[required,custom[number]] ccformfield-tel"
      value="<?php if(!empty($_POST['year'])){echo h($year);} ?>" > 年
    <input type="tel" name="month" maxlength="2" class="validate[required],custom[number]] ccformfield-tel"
      value="<?php if(!empty($_POST['month'])){echo h($month);} ?>" > 月
    <input type="tel" name="day" maxlength="2" class="validate[required,custom[number]] ccformfield-tel"
      value="<?php if(!empty($_POST['day'])){echo h($day);} ?>" > 日
    </td>
  </tr>

  <tr class="not">
  <th><span class="DDD"><i class="fa">  性別 </i></span></th>
  <td>
    <input type="radio" name="sex" value=1 class="validate[required] form-sex abc" id="male"
    <?php if(!empty($_POST['sex']) && $_POST['sex']==1){echo 'checked';} ?>>
    <label class="radio_label" for="male">男性</label>
    <input type="radio" name="sex" value=2 class="validate[required] form-sex abc" id="female"
    <?php if(!empty($_POST['sex']) && $_POST['sex']==2){echo 'checked';} ?>>
    <label class="radio_label" for="female">女性</label>
    <input type="radio" name="sex" value=9 class="validate[required] form-sex abc" id="other"
    <?php if(!empty($_POST['sex']) && $_POST['sex']==9){echo 'checked';} ?>>
    <label class="radio_label" for="other">その他</label>
  </td>
  </tr>

  <tr>
   <th><span class="DDD"><i class="fa">  連絡先電話番号 </i></span></th>
   <td>
     <input type="tel" name="tel" class="ccformfield validate[required]" maxlength="13"
       value="<?php if (!empty($_POST['tel'])) { echo h($tel); } ?>">
   </td>
 </tr>

  <tr>
   <th><span class="DDD"><i class="fa">  メールアドレス </i></span></th>
   <td><input name="mail" type="email" maxlength="254" placeholder=""
     value="<?php if((!empty($_REQUEST['um'])) || (!empty($_POST['mail']))){echo h($mail);} ?>"
     class="ccformfield"></td>
  </tr>

  <tr class="not">
  <th><span class="DDD"><i class="fa">  希望職種</i></span></th>
  <td>
    <select class="preferred abc" name="preferred" >
    	<option value="">選択してください</option>
    	<option value="1" <?php if(!empty($pre)&&$pre==1){echo 'selected';} ?>>システムエンジニア</option>
    	<option value="2" <?php if(!empty($pre)&&$pre==2){echo 'selected';} ?>>プログラマ</option>
    	<option value="3" <?php if(!empty($pre)&&$pre==3){echo 'selected';} ?>>サーバエンジニア</option>
    	<option value="4" <?php if(!empty($pre)&&$pre==4){echo 'selected';} ?>>webエンジニア</option>
    	<option value="5" <?php if(!empty($pre)&&$pre==5){echo 'selected';} ?>>データベースエンジニア</option>
    	<option value="9" <?php if(!empty($pre)&&$pre==9){echo 'selected';} ?>>その他</option>
    </select>
  </td>
  </tr>

  <tr class="not">
  <th><span class="DDD"><i class="fa">  IT経験年数</i></span></th>
  <td>
    <select class="exp abc" name="experience" >
      <option value="">選択してください</option>
      <option value="E"<?php if(!empty($exp)&&$exp=="E"){echo 'selected';} ?>>未経験</option>
      <option value="D"<?php if(!empty($exp)&&$exp=="D"){echo 'selected';} ?>>1年未満</option>
      <option value="C"<?php if(!empty($exp)&&$exp=="C"){echo 'selected';} ?>>1年以上2年未満</option>
      <option value="B"<?php if(!empty($exp)&&$exp=="B"){echo 'selected';} ?>>2年以上3年未満</option>
      <option value="A"<?php if(!empty($exp)&&$exp=="A"){echo 'selected';} ?>>3年以上</option>
    </select>
  </td>
  </tr>

  <tr class="not">
    <th><span class="DDD"><i class="fa">  長所と短所</i></span></th>
    <td><textarea name="pro_con" rows="4" cols="40" maxlength="400"placeholder="400字以内" class="validate[required] ccformfield3"><?php if(!empty($_POST['pro_con'])){echo h($pro);} ?></textarea></td>
  </tr>

  <tr class="not">
    <th><span class="DDD"><i class="fa">  自己PR</i></span></th>
    <td><textarea name="self_appeal" rows="4" cols="40" maxlength="400"placeholder="400字以内" class="validate[required] ccformfield3"><?php if(!empty($_POST['self_appeal'])){echo h($self);} ?></textarea></td>
  </tr>

  <tr class="not">
    <th><span class="DDD"><i class="fa">  人柄エピソード</i></span></th>
    <td><textarea name="episode" rows="4" cols="40" maxlength="400"placeholder="400字以内" class="validate[required] ccformfield3"><?php if(!empty($_POST['episode'])){echo h($ep);} ?></textarea></td>
  </tr>

</table>
<br><br>

  <div class="rec_box">
  <div>
  <p class="not">
    <input type="hidden" name="eat" value="0">
    <input type="checkbox" name="eat" value="1" class="ggw">
    <a href="<?php print h(D_SSL); ?>fulltime.html#meal" class="policy" target="_blank">食事会</a>参加を希望する</p>
  </div>
  </div>
  <div>
  <input type="checkbox" name="accept" value="1" class="validationEngine[required] ggw" required>
  当社における<a href="<?php print h(D_SSL); ?>privacypolicy.html" class="policy" target="_blank">個人情報取り扱い方針</a>に同意する
  </div>
  <br><br>
  <div><input class="ccbtn" type="submit" name="btn_check" value="確認"></div>
  <br>

  </form>


<?php
/// page_flag end
	}
?>



</div>
</div>





</div>
<!--page wrap end -->

<!-- end -->




</body>
</html>